name: RDP Setup

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 60  # â±ï¸ Ø²ÙŠØ§Ø¯Ø© ÙˆÙ‚Øª Ø§Ù„ØªÙ†ÙÙŠØ°
    
    steps:
      - name: Setup Ngrok and RDP
        run: |
          # ØªØ­Ù…ÙŠÙ„ ÙˆØªØ«Ø¨ÙŠØª ngrok
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .\ngrok\
          cd ngrok
          .\ngrok.exe authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

          # ØªÙ…ÙƒÙŠÙ† RDP
          net user kamel123 "MyPass123!" /add /Y
          net localgroup administrators kamel123 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Start Ngrok and Get URL
        run: |
          cd ngrok
          
          # ØªØ´ØºÙŠÙ„ ngrok ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389" -PassThru
          
          # Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
          Write-Host "ğŸ•’ Waiting for ngrok initialization..."
          timeout /t 15
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± API
          try {
              $tunnels = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels" -TimeoutSec 10
              $publicUrl = $tunnels.tunnels[0].public_url
              Write-Host "âœ… SUCCESS! RDP Connection URL:"
              Write-Host "ğŸ”— $publicUrl"
              Write-Host "ğŸ“ Use this in your Remote Desktop Client"
              
              # Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙƒÙ€ output
              echo "RDP_URL=$publicUrl" >> $env:GITHUB_ENV
          } catch {
              Write-Host "âŒ Failed to get tunnel URL: $($_.Exception.Message)"
          }
          
          # Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ù€ workflow Ù†Ø´Ø·Ø§Ù‹
          Write-Host "ğŸ”„ Keeping workflow active for 55 minutes..."
          Write-Host "ğŸ“Œ The RDP tunnel will be available until this workflow ends"
          timeout /t 3300  # â±ï¸ 55 Ø¯Ù‚ÙŠÙ‚Ø©

      - name: Show Connection Info
        if: always()
        run: |
          Write-Host "=========================================="
          Write-Host "ğŸ¯ RDP CONNECTION INFORMATION"
          Write-Host "=========================================="
          Write-Host "IP: 0.tcp.ngrok.io (or similar)"
          Write-Host "Port: Check the ngrok URL above"
          Write-Host "Username: kamel123"
          Write-Host "Password: MyPass123!"
          Write-Host "=========================================="
